-- Optional seed data (idempotent)
insert into public.offices (name, city, address, rating)
select v.name, v.city, v.address, v.rating
from (
  values
    ('Офис Центральный', 'Москва', 'ул. Ленина, 1', 95),
    ('Офис Южный', 'Краснодар', 'ул. Красная, 10', 88),
    ('Офис Северный', 'Санкт-Петербург', 'Невский пр., 25', 91)
) as v(name, city, address, rating)
where not exists (
  select 1
  from public.offices o
  where o.name = v.name
);

insert into public.news (title, body, date, pinned, author, status)
select v.title, v.body, v.date, v.pinned, v.author, v.status::public.news_status
from (
  values
    ('Обновление регламента выдачи займов', 'Новый регламент вступает в силу с 01.02.2025.', date '2025-01-20', true, 'Директор', 'published'),
    ('Запуск нового продукта «Экспресс-займ»', 'С 1 марта запускаем новый продукт.', date '2025-01-25', true, 'Директор', 'published')
) as v(title, body, date, pinned, author, status)
where not exists (
  select 1
  from public.news n
  where n.title = v.title
    and n.date = v.date
);

insert into public.kb_articles (title, category, content, date, status, version)
select
  v.title,
  v.category,
  v.content,
  v.date,
  v.status::public.kb_status,
  v.version
from (
  values
    (
      'Стандарты обслуживания клиента в МФО',
      'Общие правила',
      'Сотрудник обязан использовать понятные формулировки, вежливый тон и фиксировать все договоренности в учетной системе. Клиенту до подписания договора разъясняются: сумма займа, срок, полная стоимость кредита, график платежей, порядок досрочного погашения и последствия просрочки. Запрещено вводить клиента в заблуждение и скрывать обязательные условия.',
      date '2025-02-01',
      'published',
      1
    ),
    (
      'Идентификация клиента (KYC)',
      'Комплаенс',
      'Перед выдачей займа необходимо проверить документ, удостоверяющий личность, сверить персональные данные, подтвердить актуальность контактной информации и провести проверку по внутренним и внешним стоп-листам. При выявлении признаков недостоверности данных заявка направляется на ручную проверку и выдача приостанавливается.',
      date '2025-02-01',
      'published',
      1
    ),
    (
      'ПОД/ФТ: базовые действия сотрудника',
      'Комплаенс',
      'Операции клиента анализируются на предмет необычной активности. При наличии индикаторов риска сотрудник формирует внутреннее сообщение ответственному по ПОД/ФТ, не информируя клиента о факте проверки. Все действия фиксируются в журнале и в карточке клиента.',
      date '2025-02-01',
      'published',
      1
    ),
    (
      'Порядок оформления и выдачи займа',
      'Операции',
      'Оформление включает: прием заявки, скоринг, проверку платежеспособности, проверку ограничений, согласование условий, подписание документов и выдачу средств. До выдачи сотрудник обязан повторно сверить ключевые параметры договора и убедиться, что клиент получил экземпляр документов.',
      date '2025-02-02',
      'published',
      1
    ),
    (
      'Работа с просроченной задолженностью',
      'Взыскание',
      'При наступлении просрочки сотрудник действует по этапам: мягкое напоминание, информирование о сумме долга и вариантах урегулирования, предложение реструктуризации при наличии оснований. Коммуникация ведется только в разрешенные каналы и время, без угроз, давления и разглашения данных третьим лицам.',
      date '2025-02-02',
      'published',
      1
    ),
    (
      'Защита персональных данных клиента',
      'Информационная безопасность',
      'Персональные данные обрабатываются только для служебных целей и в рамках роли сотрудника. Запрещено передавать данные через незащищенные каналы, хранить клиентские документы на личных устройствах и использовать общие учетные записи. Любые инциденты безопасности немедленно эскалируются ответственному сотруднику.',
      date '2025-02-03',
      'published',
      1
    ),
    (
      'Кассовая дисциплина и работа с наличными',
      'Касса',
      'Операции с наличными выполняются в день обращения с обязательным оформлением кассовых документов. Сотрудник проверяет сумму, реквизиты операции и корректность отражения в системе. По окончании смены проводится сверка остатков и формируется отчетность. При расхождениях составляется акт и уведомляется руководитель офиса.',
      date '2025-02-03',
      'published',
      1
    ),
    (
      'Этика общения и урегулирование конфликтов',
      'Общие правила',
      'Сотрудник обязан сохранять нейтральный и уважительный стиль общения, не допускать дискриминационных высказываний и оценочных суждений. Конфликтные ситуации переводятся в конструктивный формат: фиксация обращения, предложение вариантов решения, передача старшему сотруднику при необходимости.',
      date '2025-02-03',
      'published',
      1
    )
) as v(title, category, content, date, status, version)
where not exists (
  select 1
  from public.kb_articles k
  where k.title = v.title
);

insert into public.courses (title, category, questions_count, passing_score, status)
select
  v.title,
  v.category,
  v.questions_count,
  v.passing_score,
  v.status::public.course_status
from (
  values
    ('Базовый курс сотрудника МФО: процессы и стандарты работы', 'Базовый', 25, 80, 'published')
) as v(title, category, questions_count, passing_score, status)
where not exists (
  select 1
  from public.courses c
  where c.title = v.title
);

insert into public.course_questions (course_id, sort_order, question, options, correct_option, explanation)
select
  c.id as course_id,
  q.sort_order,
  q.question,
  jsonb_build_array(q.option_1, q.option_2, q.option_3, q.option_4) as options,
  q.correct_option,
  q.explanation
from public.courses c
join (
  values
    (1, 'Что сотрудник обязан разъяснить клиенту до подписания договора?', 'Только сумму займа', 'Только срок займа', 'Все ключевые условия: ПСК, график, последствия просрочки', 'Только штрафы', 2, 'Клиент должен получить полную и понятную информацию о продукте и рисках.'),
    (2, 'Какое действие обязательно при первичной идентификации клиента?', 'Проверка документа, удостоверяющего личность', 'Проверка только номера телефона', 'Получение рекомендации знакомого', 'Проверка соцсетей', 0, 'Идентификация начинается с проверки официального документа и сверки данных.'),
    (3, 'Как действовать при признаках недостоверных данных в анкете?', 'Сразу выдать займ', 'Передать заявку на ручную проверку', 'Игнорировать признак', 'Удалить анкету без фиксации', 1, 'При риске фрода решение принимается только после дополнительной проверки.'),
    (4, 'Что относится к обязанностям по ПОД/ФТ?', 'Сообщать клиенту о подозрении', 'Игнорировать нетипичные операции', 'Фиксировать подозрительные операции и эскалировать ответственному', 'Удалять историю операций', 2, 'Сотрудник обязан зафиксировать и передать информацию ответственному по ПОД/ФТ.'),
    (5, 'Можно ли раскрывать третьим лицам информацию о долге клиента?', 'Да, если попросили родственники', 'Нет, это нарушение конфиденциальности', 'Да, в мессенджере', 'Да, если долг большой', 1, 'Разглашение данных третьим лицам без оснований запрещено.'),
    (6, 'Какой порядок действий при оформлении займа корректный?', 'Выдача денег, потом проверка клиента', 'Проверка, согласование, подписание, выдача', 'Сначала звонок в офис, остальное не важно', 'Только скоринг без документов', 1, 'Процесс выдачи должен соблюдать установленную последовательность этапов.'),
    (7, 'Что такое полная стоимость кредита (ПСК)?', 'Только проценты по займу', 'Сумма займа и штраф', 'Совокупная стоимость обязательств клиента по договору', 'Любая сумма по желанию сотрудника', 2, 'ПСК отражает совокупные расходы клиента по договору.'),
    (8, 'Как корректно взаимодействовать с клиентом в просрочке?', 'Угрожать и повышать голос', 'Информировать о долге и предлагать варианты урегулирования', 'Писать коллегам клиента', 'Публиковать информацию в чате дома', 1, 'Коммуникация должна быть законной, корректной и направленной на урегулирование.'),
    (9, 'Что делать при обнаружении инцидента с персональными данными?', 'Скрыть факт', 'Ничего не предпринимать', 'Немедленно уведомить ответственного и зафиксировать инцидент', 'Удалить все файлы', 2, 'Инцидент должен быть оперативно зарегистрирован и эскалирован.'),
    (10, 'Где допустимо хранить клиентские документы?', 'На личной флешке сотрудника', 'В защищенных корпоративных системах', 'В личном облаке', 'В мессенджере', 1, 'Хранение допускается только в контролируемых корпоративных контурах.'),
    (11, 'Какой принцип общения с клиентом является обязательным?', 'Оценочные и резкие суждения', 'Нейтральность и уважительный тон', 'Давление ради оплаты', 'Игнорирование вопросов клиента', 1, 'Этика обслуживания требует уважительного и нейтрального общения.'),
    (12, 'Что необходимо сделать в конце кассовой смены?', 'Оставить кассу без сверки', 'Провести сверку остатков и оформить отчетность', 'Передать деньги без документов', 'Удалить операции за день', 1, 'Сверка и отчетность обязательны для кассовой дисциплины.'),
    (13, 'Как поступить при расхождении по кассе?', 'Скрыть расхождение', 'Составить акт и уведомить руководителя', 'Переложить на коллегу', 'Списать автоматически', 1, 'Любое расхождение оформляется и эскалируется по регламенту.'),
    (14, 'Кто может изменить роль пользователя на admin?', 'Любой оператор', 'Только администратор/директор по установленному процессу', 'Любой сотрудник офиса', 'Клиент через обращение', 1, 'Изменение ролей относится к административным полномочиям.'),
    (15, 'Как проверить доступ к данным в системе?', 'Открыть все таблицы всем сотрудникам', 'Использовать ролевую модель и политику доступа', 'Отправить пароль коллеге', 'Отключить авторизацию', 1, 'Доступ должен ограничиваться ролью и служебной необходимостью.'),
    (16, 'Какой статус у курса должен быть, чтобы он был доступен всем сотрудникам?', 'draft', 'archived', 'published', 'любой', 2, 'Публично доступными должны быть опубликованные курсы.'),
    (17, 'Что такое попытка прохождения курса?', 'Любой просмотр страницы', 'Фиксируемый результат теста с баллом и номером попытки', 'Удаление старой оценки', 'Создание курса', 1, 'Попытка содержит результат тестирования и используется для аттестации.'),
    (18, 'Когда формируется запись об аттестации?', 'Только вручную раз в год', 'После каждой зафиксированной попытки курса', 'После входа в систему', 'После назначения курса', 1, 'Аттестация формируется по факту прохождения попытки.'),
    (19, 'Как правильно назначать обучение сотрудникам?', 'Без срока и без фиксации', 'Через назначение курса с фиксацией ответственного и срока', 'Через личный чат', 'Через устное распоряжение без записи', 1, 'Назначения должны быть прозрачными и фиксируемыми в системе.'),
    (20, 'Что делать, если клиент просит объяснить расчет платежа?', 'Отказать без объяснений', 'Объяснить структуру платежа понятным языком', 'Сказать “так считает система”', 'Направить к другому клиенту', 1, 'Клиент имеет право получить понятное объяснение расчетов.'),
    (21, 'Какой подход к коммуникации при конфликте корректен?', 'Спорить и доказывать правоту любой ценой', 'Фиксировать обращение и предложить варианты решения', 'Прекратить диалог', 'Перевести разговор в личные оценки', 1, 'Конфликт урегулируется в процессном и уважительном формате.'),
    (22, 'Что из перечисленного является нарушением ИБ?', 'Работа через корпоративный аккаунт', 'Передача клиентских данных в личный мессенджер', 'Блокировка экрана при уходе', 'Использование служебной почты', 1, 'Передача ПДн через незащищенные личные каналы недопустима.'),
    (23, 'Какой минимальный результат нужен для зачета курса с порогом 80?', '79', '80', '50', '100 только', 1, 'Порог прохождения считается включительно.'),
    (24, 'Что должно быть в карточке клиента после контакта?', 'Ничего, устно достаточно', 'Краткая фиксация результата и договоренностей', 'Только имя сотрудника', 'Только время звонка без сути', 1, 'Фиксация действий и договоренностей обязательна для качества и контроля.'),
    (25, 'Какой общий принцип должен соблюдать сотрудник МФО?', 'Максимальная выдача займов любой ценой', 'Соблюдение закона, регламентов и интересов клиента', 'Сокрытие условий договора', 'Передача решений неуполномоченным лицам', 1, 'Работа сотрудника строится на законности, прозрачности и ответственности.')
) as q(sort_order, question, option_1, option_2, option_3, option_4, correct_option, explanation)
  on c.title = 'Базовый курс сотрудника МФО: процессы и стандарты работы'
where not exists (
  select 1
  from public.course_questions cq
  where cq.course_id = c.id
    and cq.sort_order = q.sort_order
);
